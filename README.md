# Stable Diffusion 图片生成器

一个基于Stable Diffusion模型的跨平台AI图片生成应用程序，提供简洁易用的图形界面。

## 功能特性

- 🎨 **AI图片生成**: 基于Stable Diffusion 3.5 Large模型
- 🔄 **多模型支持**: 手动选择和切换不同的SD模型
- 📥 **自动模型下载**: 智能检测和下载最新模型，支持断点续传
- 💻 **本地模型支持**: 支持加载本地已下载的模型文件
- 🖥️ **现代化界面**: 基于PyQt5的专业级用户界面
- 🎛️ **丰富参数调整**: 支持尺寸、采样步数、引导系数、随机种子等参数
- 🖼️ **实时预览**: 生成过程可视化和结果预览
- 💾 **智能保存**: 自动生成文件名，保存图片元数据
- ⚡ **性能优化**: 自动GPU/CPU检测，内存优化
- 🔧 **一键启动**: 包含环境检查和自动修复

## 系统要求

### 最低配置
- **操作系统**: Windows 10+ 或 Linux (Ubuntu 18.04+)
- **Python**: 3.8 - 3.11
- **内存**: 8GB RAM
- **存储**: 10GB 可用空间
- **网络**: 首次运行需要下载模型文件

### 推荐配置
- **内存**: 16GB+ RAM
- **GPU**: NVIDIA GPU (6GB+ 显存)
- **存储**: SSD硬盘

## 快速开始

### 一键启动（推荐）

1. **下载项目文件**
   ```bash
   git clone <repository-url>
   cd sd-image-generator
   ```

2. **运行启动脚本**
   ```bash
   python start.py
   ```

   启动脚本会自动完成以下操作：
   - ✅ 检查Python版本兼容性
   - ✅ 检查并安装缺失的依赖包
   - ✅ 检测最佳pip镜像源
   - ✅ 检查系统资源和GPU支持
   - ✅ 创建必要的工作目录
   - ✅ 启动图形界面应用程序

### 手动安装（可选）

如果自动安装失败，可以手动安装：

1. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

2. **运行程序**
   ```bash
   python main.py
   ```

### 直接启动

如果启动脚本失败，可以直接运行主程序：

```bash
python main.py
```

**界面特性**:
- 现代化PyQt5设计，美观易用
- 响应式布局，支持窗口缩放
- 专业的模型选择和管理功能
- 支持本地模型和在线模型
- 实时进度反馈和状态显示

### 使用setup.py安装（开发者）

```bash
pip install -e .
sd-generator
```

## 使用说明

### 基本操作

1. **启动应用**: 运行 `python start.py` 或 `python main.py`
2. **选择模型**: 通过"模型 -> 选择模型"菜单选择合适的SD模型
3. **等待模型加载**: 首次使用新模型会自动下载（约8-10GB）
4. **输入提示词**: 在"描述"框中输入想要生成的图片描述
5. **调整参数**: 根据需要调整图片尺寸、采样步数等参数
6. **生成图片**: 点击"生成图片"按钮开始生成
7. **保存结果**: 生成完成后点击"保存图片"保存到本地

### 模型选择

应用支持多种Stable Diffusion模型，可通过菜单选择：

**预设模型**:
- **SD 3.5 Large** (推荐): 最新模型，质量最高
- **SD 3.5 Medium**: 中等大小，平衡性能和质量
- **SD v1.5**: 经典模型，兼容性好
- **SD v2.1**: 改进版本，更好的文本理解
- **SDXL Base**: 高分辨率专用模型

**自定义模型**: 支持输入任何Hugging Face模型ID

**本地模型**: 支持加载本地已下载的模型
- 支持模型文件(.safetensors, .bin, .ckpt, .pth)
- 支持模型目录(包含model_index.json等配置文件)
- 离线使用，加载速度更快
- 通过"浏览"按钮选择本地模型路径

### 参数说明

- **描述 (Prompt)**: 描述想要生成的图片内容，支持英文
- **负向提示词**: 描述不想要的内容，用于排除特定元素
- **宽度/高度**: 生成图片的尺寸，必须是8的倍数（推荐1024x1024）
- **采样步数**: 生成质量，数值越高质量越好但速度越慢（推荐28步）
- **引导系数**: 对提示词的遵循程度（推荐3.5）
- **随机种子**: 控制生成的随机性，相同种子产生相同结果

### 提示词技巧

1. **具体描述**: 使用具体、详细的描述
   - ✅ "a beautiful sunset over mountains with orange and pink clouds"
   - ❌ "nice picture"

2. **艺术风格**: 可以指定艺术风格
   - "in the style of Van Gogh"
   - "digital art"
   - "photorealistic"

3. **质量词汇**: 添加质量提升词汇
   - "highly detailed"
   - "8k resolution"
   - "masterpiece"

4. **负向提示**: 使用负向提示排除不想要的内容
   - "blurry, low quality, distorted"

## 目录结构

```
sd-image-generator/
├── main.py                 # 主程序入口(PyQt5)
├── start.py                # 启动脚本(含环境检查)
├── gui_qt.py               # PyQt5图形用户界面
├── sd_generator.py         # SD核心生成模块
├── config.py               # 配置管理
├── utils.py                # 工具函数
├── setup.py                # 安装脚本
├── requirements.txt        # 依赖列表
├── README.md               # 使用说明
├── 开发计划.md             # 开发计划
├── outputs/                # 生成图片输出目录
├── logs/                   # 日志文件目录
└── ~/.sd_generator/        # 用户配置和模型缓存
    ├── config.json         # 用户配置文件
    └── models/             # 模型缓存目录
```

## 配置说明

应用程序会在用户目录下创建 `.sd_generator` 文件夹存储配置和模型：

- **配置文件**: `~/.sd_generator/config.json`
- **模型缓存**: `~/.sd_generator/models/`
- **输出目录**: `./outputs/`
- **日志目录**: `./logs/`

可以通过修改 `config.py` 或界面菜单调整配置。

## 故障排除

### 常见问题

1. **模型下载失败**
   - 检查网络连接
   - 尝试使用VPN
   - 手动下载模型到缓存目录

2. **内存不足**
   - 关闭其他应用程序
   - 在配置中启用"低显存模式"
   - 使用较小的图片尺寸

3. **生成速度慢**
   - 确保使用GPU模式
   - 减少采样步数
   - 检查GPU驱动是否最新

4. **CUDA错误**
   - 更新NVIDIA驱动
   - 重新安装PyTorch
   - 检查CUDA版本兼容性

### 日志查看

程序运行日志保存在 `logs/sd_generator.log`，可以查看详细错误信息。

### 重置配置

删除 `~/.sd_generator/config.json` 文件可以重置为默认配置。

## 性能优化

### 🚀 GPU加速配置（重要）

**性能提升**: GPU模式比CPU模式快5-15倍！

#### 快速GPU配置
```bash
# 1. 检查当前配置
python test_gpu_config.py

# 2. 自动安装GPU版本PyTorch
python install_gpu_pytorch.py

# 3. 验证配置
python test_gpu_config.py
```

#### 性能对比
| 硬件配置 | CPU模式 | GPU模式 | 提升倍数 |
|----------|---------|---------|----------|
| RTX 4090 | 45秒 | 3秒 | **15倍** |
| RTX 3080 | 50秒 | 5秒 | **10倍** |
| RTX 3060 | 55秒 | 8秒 | **7倍** |
| GTX 1660 | 60秒 | 12秒 | **5倍** |

#### 手动配置GPU
如果自动配置失败，请参考 [GPU配置指南.md](GPU配置指南.md)

### GPU优化设置
应用程序会根据GPU内存自动优化：
- **12GB+**: 最高质量模式，BFloat16精度
- **8-12GB**: 高质量模式，启用优化
- **6-8GB**: 平衡模式，CPU卸载
- **4-6GB**: 低显存模式，内存优化
- **2-4GB**: 极限模式，最大优化

### CPU模式
- 虽然速度较慢，但在没有GPU的情况下仍可使用
- 建议使用较小的图片尺寸和较少的采样步数
- 自动启用CPU优化设置

## 技术栈

- **深度学习**: PyTorch + Hugging Face Diffusers
- **用户界面**: PyQt5 (现代化专业界面)
- **图像处理**: Pillow (PIL)
- **模型**: Stable Diffusion 3.5 Large + 本地模型支持

## 许可证

MIT License

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 更新日志

### v1.4.0 (2024-12-09)
- 🚀 **重大更新**: 优化GPU配置，大幅提升性能
- 🎮 智能GPU检测，自动选择最优设备（CPU/CUDA）
- ⚡ GPU模式性能提升5-15倍，生成速度大幅提升
- 🔧 新增GPU配置测试脚本 (`test_gpu_config.py`)
- 📦 新增CUDA版本PyTorch自动安装脚本 (`install_gpu_pytorch.py`)
- 📋 根据GPU内存自动优化设置（BFloat16/Float16精度）
- 🛠️ 改进设备配置逻辑，更好的fallback机制
- 📖 新增详细的GPU配置指南和性能对比
- 🔄 优化启动脚本，支持CUDA版本PyTorch安装
- ⚙️ 更新配置系统，设备设置改为"auto"智能检测

### v1.3.0 (2024-12-07)
- 🗑️ 移除Tkinter界面，专注PyQt5单一界面
- 💻 新增本地模型支持，可加载本地模型文件
- 📁 支持模型文件和目录浏览选择
- 🔧 简化启动流程，直接启动PyQt5界面
- ⚡ 优化代码结构，移除冗余代码
- 📊 增强本地模型验证和信息显示

### v1.2.0 (2024-12-07)
- 🔄 新增手动模型选择功能
- 📋 支持多种预设模型和自定义模型
- 🚪 优化退出行为，不再自动保存配置
- 📊 增强模型信息显示
- 🎨 升级到PyQt5现代化界面
- 🖥️ 双界面支持，自动选择最佳版本
- 🧵 改进线程处理和响应性能

### v1.1.0 (2024-12-07)
- 🚀 升级到Stable Diffusion 3.5 Large模型
- 📥 新增自动模型下载功能
- 🔧 修复Python 3.8兼容性问题
- ⚙️ 优化默认参数设置
- 🌐 增强网络连接检查和重试机制

### v1.0.0
- 初始版本发布
- 支持Stable Diffusion v1.5
- 跨平台GUI界面
- 基本参数调整功能
- 自动环境检查和修复

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues: [项目Issues页面]
- Email: [联系邮箱]

---

**注意**: 本应用仅供学习和研究使用，请遵守相关法律法规，不要生成不当内容。
